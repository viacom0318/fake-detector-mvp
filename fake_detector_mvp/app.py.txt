import streamlit as st
import pandas as pd
import networkx as nx
import matplotlib.pyplot as plt
from datetime import datetime, timezone
from difflib import SequenceMatcher

# æ–‡å­—ç›¸ä¼¼åº¦å‡½æ•¸
def text_similarity(a, b):
    return SequenceMatcher(None, a.lower(), b.lower()).ratio()

# Mockæ•¸æ“šï¼ˆæ¸¬è©¦ç”¨ï¼Œæ¨¡æ“¬çœŸå¯¦APIå›å‚³ï¼‰
def get_mock_user_data(username):
    mock_data = {
        "elonmusk": {  # æ­£å¸¸å¸³è™Ÿ
            "username": "elonmusk",
            "followers": 200000000,
            "following": 500,
            "tweet_count": 30000,
            "created_at": datetime(2006, 6, 1, tzinfo=timezone.utc),
            "recent_tweets": ["Hello world", "Mars mission update", "Tesla news today"] * 10
        },
        "fakebot123": {  # é«˜é¢¨éšªå‡å¸³è™Ÿ
            "username": "fakebot123",
            "followers": 50,
            "following": 2000,
            "tweet_count": 5000,
            "created_at": datetime(2025, 12, 1, tzinfo=timezone.utc),
            "recent_tweets": ["æŠ•è³‡è³ºå¤§éŒ¢ï¼ç§è¨Šæˆ‘"] * 50
        },
        "normaluser": {  # ä¸­ç­‰æ­£å¸¸
            "username": "normaluser",
            "followers": 1000,
            "following": 800,
            "tweet_count": 2000,
            "created_at": datetime(2015, 1, 1, tzinfo=timezone.utc),
            "recent_tweets": ["ä»Šå¤©åƒäº†å¥½åƒçš„", "å·¥ä½œå¥½ç´¯", "çœ‹é›»å½±æ¨è–¦"] * 20
        }
    }
    return mock_data.get(username.lower(), None)

def get_mock_retweeters():
    return ["bot1", "bot2", "bot3", "scamaccount", "fakeuser"] * 10  # æ¨¡æ“¬50å€‹è½‰ç™¼è€…

# ä¸»é é¢
st.title("ğŸ‡¹ğŸ‡¼ å°ç£å‡å¸³è™Ÿï¼å‡æ¶ˆæ¯æª¢æ¸¬ MVPï¼ˆæ¸¬è©¦ç‰ˆï¼‰")
st.markdown("### å…ˆç”¨mockæ•¸æ“šç©ç©çœ‹ï¼Œç¢ºèªä»‹é¢èˆ‡é‚è¼¯ â†’ ä¹‹å¾Œå†æ¥çœŸå¯¦X API")

tab1, tab2 = st.tabs(["å‡å¸³è™Ÿæª¢æ¸¬", "å‚³æ’­æº¯æº"])

with tab1:
    username = st.text_input("è¼¸å…¥æ¸¬è©¦å¸³è™Ÿï¼ˆè©¦è©¦ï¼šelonmusk / fakebot123 / normaluserï¼‰", placeholder="elonmusk")
    if st.button("é–‹å§‹æª¢æ¸¬"):
        with st.spinner("æ¨¡æ“¬æª¢æ¸¬ä¸­..."):
            mock_user = get_mock_user_data(username)
            if not mock_user:
                st.error("ç„¡æ­¤mockå¸³è™Ÿï¼Œè«‹è©¦è©¦å…§å»ºçš„ä¸‰å€‹ç¯„ä¾‹")
                st.stop()
            
            # åŸºæœ¬ç‰¹å¾µè¨ˆç®—
            followers = mock_user["followers"]
            following = mock_user["following"]
            follower_ratio = followers / max(1, following)
            account_age_days = (datetime.now(timezone.utc) - mock_user["created_at"]).days
            tweets_per_day = mock_user["tweet_count"] / max(1, account_age_days)
            
            # è²¼æ–‡é‡è¤‡åº¦
            tweet_texts = mock_user["recent_tweets"]
            avg_similarity = 0
            if len(tweet_texts) > 5:
                sims = [text_similarity(tweet_texts[i], tweet_texts[j])
                        for i in range(len(tweet_texts))
                        for j in range(i + 1, len(tweet_texts))]
                avg_similarity = sum(sims) / len(sims) if sims else 0
            
            # è¦å‰‡è©•åˆ†
            fake_score = 0
            if follower_ratio < 0.2:   fake_score += 30
            if tweets_per_day > 20:    fake_score += 30
            if account_age_days < 90:  fake_score += 20
            if avg_similarity > 0.7:   fake_score += 20
            
            # é¡¯ç¤ºçµæœ
            st.subheader(f"@{mock_user['username']} æª¢æ¸¬çµæœ")
            col1, col2 = st.columns(2)
            with col1:
                st.metric("è¿½éš¨è€…æ•¸", followers)
                st.metric("è¿½éš¨ä¸­æ•¸", following)
                st.metric("è¿½éš¨æ¯”", f"{follower_ratio:.2f}")
            with col2:
                st.metric("å¸³è™Ÿå¹´é½¡", f"{account_age_days} å¤©")
                st.metric("æ¯æ—¥è²¼æ–‡æ•¸", f"{tweets_per_day:.1f}")
                st.metric("è²¼æ–‡å¹³å‡ç›¸ä¼¼åº¦", f"{avg_similarity:.2f}")
            
            st.progress(fake_score / 100)
            st.write(f"### å‡å¸³è™Ÿé¢¨éšªè©•åˆ†ï¼š**{fake_score}%**ï¼ˆè¦å‰‡ä¼°è¨ˆï¼‰")
            if fake_score > 70:
                st.error("ğŸš¨ é«˜é¢¨éšªï¼æ¥µå¯èƒ½ç‚ºå‡å¸³è™Ÿæˆ–è‡ªå‹•åŒ–å¸³è™Ÿ")
            elif fake_score > 40:
                st.warning("âš ï¸ ä¸­é¢¨éšªï¼Œå»ºè­°é€²ä¸€æ­¥è§€å¯Ÿ")
            else:
                st.success("âœ… ä½é¢¨éšªï¼Œçœ‹èµ·ä¾†æ­£å¸¸")

with tab2:
    if st.button("æ¨¡æ“¬æº¯æºï¼ˆé»æˆ‘çœ‹ç¯„ä¾‹ç¶²è·¯åœ–ï¼‰"):
        with st.spinner("æ¨¡æ“¬æŠ“å–è½‰ç™¼è€…..."):
            retweeters = get_mock_retweeters()
            st.write(f"æ‰¾åˆ° **{len(retweeters)}** ä½è½‰ç™¼è€…ï¼ˆæ¨¡æ“¬æ•¸æ“šï¼‰")
            st.write(", ".join([f"@{u}" for u in retweeters[:30]]) + " ...")
            
            # ç¶²è·¯åœ–
            G = nx.Graph()
            G.add_node("åŸè²¼æ–‡")
            for u in retweeters:
                G.add_node(f"@{u}")
                G.add_edge("åŸè²¼æ–‡", f"@{u}")
            
            fig, ax = plt.subplots(figsize=(12, 8))
            nx.draw(G, with_labels=True, node_color='lightcoral' if len(retweeters)>20 else 'lightblue',
                    edge_color='gray', node_size=1000, font_size=9)
            st.pyplot(fig)

st.info("ğŸ‘ é€™æ˜¯ç´”mockæ¸¬è©¦ç‰ˆï¼Œè·‘èµ·ä¾†å¾Œå‘Šè¨´æˆ‘æ„Ÿè¦ºå¦‚ä½•ï¼Ÿæƒ³æ”¹è¦å‰‡ã€åŠ åŠŸèƒ½ã€ç¾åŒ–ä»‹é¢ã€é‚„æ˜¯æ¥çœŸå¯¦APIï¼Œéƒ½ç›´æ¥èªªï¼Œæˆ‘é¦¬ä¸Šå¹«ä½ èª¿æ•´ï¼")